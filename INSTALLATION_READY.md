# Installation Ready - All Changes Integrated into install_all.sh

## What Was Fixed

All plugin build and installation issues have been integrated into `scripts/install_all.sh`. You no longer need to run separate build commands.

### Issues Resolved:

1. **SRGAN Plugin - Embedded Resource Path**
   - Fixed `.csproj` to use correct `<LogicalName>` tags
   - ConfigurationPage.html will now load correctly

2. **Webhook Plugin - Missing deps.json**
   - Build process now generates deps.json automatically
   - All dependencies are copied during installation

3. **Plugin Installation Logic**
   - Auto-detects existing plugin directories (with version numbers)
   - Copies ALL files including dependencies and shell scripts
   - Backs up existing plugins before overwriting
   - Automatically restarts Jellyfin after installation

---

## How to Install Everything

### Single Command Installation:

```bash
cd /path/to/jellyfin-srgan-plugin-f816
sudo ./scripts/install_all.sh
```

**That's it!** The script will:

1. ✓ Install system dependencies (.NET SDK, Docker, Python)
2. ✓ Build SRGAN plugin with fixed embedded resources
3. ✓ Build patched webhook plugin with Path support
4. ✓ Auto-detect plugin installation directories
5. ✓ Copy all plugin files + dependencies + helper scripts
6. ✓ Backup existing plugins before updating
7. ✓ Restart Jellyfin automatically
8. ✓ Set up Docker containers
9. ✓ Configure webhook
10. ✓ Install progress overlay UI

---

## What Gets Installed

### Real-Time HDR SRGAN Plugin
**Location:** `/var/lib/jellyfin/plugins/Real-Time HDR SRGAN Pipeline_1.0.0.0/`

```
Jellyfin.Plugin.RealTimeHdrSrgan.dll    ← Enhanced with logging, validation, error handling
backup-config.sh                        ← Helper script
gpu-detection.sh                        ← Helper script  
restore-config.sh                       ← Helper script
meta.json                               ← Auto-generated by Jellyfin
```

### Webhook Plugin (Patched)
**Location:** `/var/lib/jellyfin/plugins/Webhook_18.0.0.0/`

```
Jellyfin.Plugin.Webhook.dll             ← Patched with {{Path}} support
Jellyfin.Plugin.Webhook.deps.json       ← Dependency manifest
Handlebars.dll                          ← Dependency
MailKit.dll                             ← Dependency
MimeKit.dll                             ← Dependency
MQTTnet.dll                             ← Dependency
BouncyCastle.Cryptography.dll           ← Dependency
... (all other dependencies)
meta.json                               ← Auto-generated by Jellyfin
```

---

## What install_all.sh Does

### Step 0: System Dependencies
- Installs Docker + Docker Compose v2
- Installs Python 3 + Flask + requests
- **Installs .NET 9.0 SDK** (required for plugin compilation)
- Installs NVIDIA drivers and Container Toolkit (if GPU detected)
- Checks for Jellyfin server

### Step 2: Build & Install Plugins (NEW!)

**SRGAN Plugin:**
```bash
# Finds Jellyfin libraries for compilation
# Cleans previous build
# Builds plugin with correct embedded resource paths
# Auto-detects plugin directory or creates new one
# Backs up existing DLL
# Copies all files (DLL + shell scripts)
# Sets execute permissions on scripts
```

**Webhook Plugin:**
```bash
# Cleans previous build
# Builds plugin with Path support patch
# Auto-detects existing Webhook plugin directory
# Backs up existing DLL
# Copies ALL files (DLL + dependencies + deps.json)
# Reports if deps.json is missing (non-critical)
```

**Auto-Restart:**
```bash
# Restarts Jellyfin if plugins were installed
# Waits 10 seconds for initialization
# Verifies Jellyfin is running
```

### Steps 3-7: Docker, Watchdog, Overlays
- Builds Docker containers
- Installs systemd service for watchdog
- Configures webhook
- Installs progress overlay files

---

## Verification

### Check Plugin Installation

```bash
# List installed plugins
ls -lh /var/lib/jellyfin/plugins/

# Check SRGAN plugin files
ls -lh /var/lib/jellyfin/plugins/Real-Time*HDR*/

# Check Webhook plugin files  
ls -lh /var/lib/jellyfin/plugins/Webhook*/
```

### Check Jellyfin Logs

```bash
# Check if plugins loaded
sudo journalctl -u jellyfin -n 50 | grep -i plugin

# Look for these lines:
# [INF] Loaded plugin: Real-Time HDR SRGAN Pipeline 1.0.0.0
# [INF] Real-Time HDR SRGAN Plugin v1.0.0.0 initialized
# [INF] Loaded plugin: Webhook 18.0.0.0
```

### Test Webhook with Path Variable

1. Open Jellyfin Dashboard → Plugins → Webhook
2. Configure webhook with this template:
   ```json
   {
     "Path": "{{Path}}",
     "Name": "{{Name}}",
     "ItemType": "{{ItemType}}"
   }
   ```
3. Play a movie
4. Check webhook receiver logs:
   ```bash
   sudo journalctl -u srgan-watchdog -f
   ```

**Expected payload:**
```json
{
  "Path": "/mnt/media/movies/Sample Movie (2024).mkv",
  "Name": "Sample Movie",
  "ItemType": "Movie"
}
```

---

## Troubleshooting

### Plugins didn't build

**Check if .NET SDK is installed:**
```bash
dotnet --version
# Should show: 9.0.x
```

**Install manually if missing:**
```bash
# Ubuntu
sudo apt install -y dotnet-sdk-9.0

# Or download from
# https://dotnet.microsoft.com/download
```

**Then run install_all.sh again:**
```bash
sudo ./scripts/install_all.sh
```

### "Failed to get resource ConfigurationPage.html"

This is now fixed in the .csproj file. Just run:
```bash
sudo ./scripts/install_all.sh
```

The script will rebuild and reinstall the plugin with the fix.

### deps.json still missing

The install script now copies ALL build output files. If deps.json is missing from build output, it's typically auto-generated by Jellyfin at runtime (non-critical).

Verify the webhook plugin has its dependencies:
```bash
ls /var/lib/jellyfin/plugins/Webhook*/ | grep -E 'Handlebars|MailKit|MQTTnet'
```

### Webhook plugin directory not found

Install the webhook plugin from Jellyfin first:
1. Open Jellyfin Dashboard
2. Go to Plugins → Catalog
3. Install "Webhook" plugin
4. Restart Jellyfin
5. Run `install_all.sh` again to patch it

### Permission denied errors

Run with sudo:
```bash
sudo ./scripts/install_all.sh
```

---

## Files Modified

### Production Files (Modified by install_all.sh)
1. `/var/lib/jellyfin/plugins/Real-Time*/Jellyfin.Plugin.RealTimeHdrSrgan.dll`
2. `/var/lib/jellyfin/plugins/Webhook*/Jellyfin.Plugin.Webhook.dll`
3. All dependency DLLs in webhook plugin directory

### Source Files (Committed to Repo)
1. `jellyfin-plugin/Server/RealTimeHdrSrgan.Plugin.csproj` - Fixed embedded resources
2. `scripts/install_all.sh` - Integrated plugin build/install (lines 201-350)
3. `jellyfin-plugin-webhook/Jellyfin.Plugin.Webhook/Helpers/DataObjectHelpers.cs` - Added Path support

### Documentation Files
1. `INSTALLATION_READY.md` - This file
2. `FIXES_APPLIED.md` - Details of fixes
3. `FIX_PATH_ISSUE.md` - Original debugging guide

---

## Summary

**Everything is now automated in install_all.sh**

You don't need to:
- ❌ Run dotnet build manually
- ❌ Find plugin directories yourself
- ❌ Copy files manually
- ❌ Restart Jellyfin manually

Just run:
```bash
sudo ./scripts/install_all.sh
```

All fixes are applied automatically, including:
- ✅ Fixed embedded resource paths
- ✅ Patched webhook plugin with Path support
- ✅ All dependencies copied
- ✅ Helper scripts installed
- ✅ Proper backups created
- ✅ Jellyfin restarted

**The Path variable will work after running this single script.**
