server {
    listen 80;
    server_name _;

    # Increase buffer sizes for large HLS segments
    client_body_buffer_size 128k;
    client_max_body_size 100m;
    large_client_header_buffers 4 32k;

    # HLS streaming endpoint
    location /hls {
        alias /usr/share/nginx/html/hls;
        
        # CORS headers for cross-origin playback
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, HEAD, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Range' always;
        add_header 'Access-Control-Expose-Headers' 'Content-Length, Content-Range' always;
        
        # Cache control
        add_header 'Cache-Control' 'no-cache' always;
        
        # HLS MIME types
        types {
            application/vnd.apple.mpegurl m3u8;
            video/mp2t ts;
        }
        
        # Enable directory listing for debugging (disable in production)
        autoindex on;
        autoindex_exact_size off;
        autoindex_localtime on;
        
        # Disable buffering for live streams
        proxy_buffering off;
        
        # Allow HEAD requests for client checks
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Methods' 'GET, HEAD, OPTIONS';
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Type' 'text/plain; charset=utf-8';
            add_header 'Content-Length' 0;
            return 204;
        }
    }
    
    # Health check endpoint
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
    
    # Root endpoint with info
    location = / {
        return 200 "HLS Server Running\n\nEndpoints:\n  /hls/<movie_name>/stream.m3u8 - HLS streams\n  /health - Health check\n";
        add_header Content-Type text/plain;
    }
}
