services:
  hdr-srgan-pipeline:
    build:
      context: .
      dockerfile: Dockerfile
    image: real-time-hdr-srgan-pipeline:latest
    container_name: hdr-srgan-pipeline
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,video,utility
      - CUDA_VISIBLE_DEVICES=0
    volumes:
      - ./scripts:/app/scripts:ro
      - ./input:/app/input:rw
      - ./output:/app/output:rw
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu, compute, video]
    restart: unless-stopped
    networks:
      - hdr-srgan-network

  srgan-upscaler:
    build: .
    image: srgan_live_upscaler:latest
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu, video]
    volumes:
      # Media input paths (add your Jellyfin media directories here)
      # The container needs access to the same paths Jellyfin uses
      # Example: If Jellyfin has /media/movies, mount: - /media:/media:ro
      - /media:/media:ro                    # Common: /media/movies, /media/tv
      - /mnt/media:/mnt/media:ro            # Common: /mnt/media/movies
      - /srv/media:/srv/media:ro            # Common: /srv/media
      # Output and working directories
      - /mnt/media/upscaled:/data/upscaled  # Upscaled output
      - ./cache:/app/cache                   # Queue file
      - ./models:/app/models:ro              # AI models
    environment:
      - NVIDIA_DRIVER_CAPABILITIES=all
      - PYTHONUNBUFFERED=1
      - SRGAN_ENABLE=0
      - SRGAN_MODEL_PATH=/app/models/swift_srgan_4x.pth
      - SRGAN_DEVICE=cuda
      - SRGAN_FP16=1
      - SRGAN_WAIT_SECONDS=-1
      - SRGAN_QUEUE_FILE=/app/cache/queue.jsonl
      - SRGAN_QUEUE_POLL_SECONDS=0.2
      - UPSCALED_DIR=/data/upscaled
      - SRGAN_FFMPEG_HWACCEL=1
      - SRGAN_FFMPEG_RTBUFSIZE=100M
      - SRGAN_FFMPEG_ENCODER=hevc_nvenc
      - SRGAN_FFMPEG_PRESET=fast
      - SRGAN_FFMPEG_BUFSIZE=100M
      - SRGAN_FFMPEG_DELAY=0
      - SRGAN_COLOR_PRIMARIES=bt2020
      - SRGAN_COLOR_TRC=smpte2084
      - SRGAN_SCALE_FACTOR=2.0
      - HLS_SEGMENT_TIME=6
      - HLS_LIST_SIZE=0
      - HLS_FLAGS=append_list+omit_endlist
      - ENABLE_HLS_STREAMING=1
      - HLS_SERVER_HOST=localhost
      - HLS_SERVER_PORT=8080
    ulimits:
      memlock: -1
      stack: 67108864
    restart: unless-stopped
    networks:
      - hdr-srgan-network

  hls-server:
    image: nginx:alpine
    container_name: hls-server
    ports:
      - "8080:80"
    volumes:
      - /mnt/media/upscaled/hls:/usr/share/nginx/html/hls:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped
    networks:
      - hdr-srgan-network

  # Optional: Jellyfin service integration
#  jellyfin:
#    image: jellyfin/jellyfin:latest
#    container_name: jellyfin
#    runtime: nvidia
#    environment:
#      - NVIDIA_VISIBLE_DEVICES=all
#      - NVIDIA_DRIVER_CAPABILITIES=compute,video,utility
#      - JELLYFIN_PublishedServerUrl=http://localhost:8096
#    volumes:
#      - ./jellyfin-config:/config:rw
#      - ./jellyfin-cache:/cache:rw
#      - ./jellyfin-plugin:/config/plugins/RealTimeHDRSRGAN:ro
#      - ./media:/media:ro
#    ports:
#      - "8096:8096"
#      - "8920:8920"
#    deploy:
#      resources:
#        reservations:
#          devices:
#            - driver: nvidia
#              count: all
#              capabilities: [gpu, compute, video]
#    restart: unless-stopped
#    networks:
#      - hdr-srgan-network
#    profiles:
#      - jellyfin-integration

networks:
  hdr-srgan-network:
    driver: bridge

volumes:
  jellyfin-config:
  jellyfin-cache:
